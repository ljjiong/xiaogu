{include file="header" /}

<body>
  <section class="el-container  is-vertical">
    {include file="top" /}
    <section class="el-container">
      {include file="left" /}
      <section class="el-container  is-vertical">
        <main class="el-main" id="main">
          <div id="app">
            <fieldset>
              <legend>商品列表</legend>
            </fieldset>
            <!-- 筛选 -->
            <el-row style="margin-bottom: 10px;">
              <el-col>
                <el-card>
                  <div slot="header">
                    <span>查询</span>
                  </div>
                  <el-row :gutter="20">
                    <!-- 筛选条件 -->
                    <el-col :span="5">
                      <span style="padding: 0px  10px;">商品分类</span>
                      <el-cascader change-on-select v-model="cate_ids" :options="cates" expand-trigger="hover"></el-cascader>
                    </el-col>
                    <el-col :span="5">
                      <el-input placeholder="请输入商品名称" v-model="searchData.name">
                        <template slot="prepend">商品名称</template>
                      </el-input>
                    </el-col>
                    <!-- 筛选按钮 -->
                    <el-col :span="4">
                      <el-button icon="el-icon-search" @click="search();"></el-button>
                      <el-button icon="el-icon-refresh" @click="refresh();"></el-button>
                    </el-col>
                  </el-row>
                </el-card>
              </el-col>
            </el-row>
            <!-- 列表 -->
            <el-row>
              <el-col>
                <el-card>
                  <div slot="header">
                    <span>商品列表</span>
                    <el-button type="primary" style="float: right;" size="mini" icon="el-icon-plus" @click="goAdd()">新增商品</el-button>
                  </div>
                  <!-- 批量操作 -->
                  <div style="margin-bottom: 10px">
                    <el-button type="danger" size="small" plain icon="el-icon-delete" @click="multiOperate('delete')" :disabled="multipleSelection.length == 0">批量删除</el-button>
                    <el-button type="danger" size="small" plain icon="el-icon-error" @click="multiOperate('off_line')" :disabled="multipleSelection.length == 0">批量下架</el-button>
                    <el-button type="success" size="small" plain icon="el-icon-success" @click="multiOperate('on_line')" :disabled="multipleSelection.length == 0">批量上架</el-button>
                  </div>
                  <!-- 表格 -->
                  <template>
                    <el-table :data="tableData" stripe style="width: 100%" @selection-change="handleSelectionChange">
                      <el-table-column type="selection" width="55"> </el-table-column>
                      <el-table-column prop="id" label="ID" width="80" fixed sortable></el-table-column>
                      <el-table-column prop="name" label="名称" fixed></el-table-column>
                      <el-table-column prop="goods_cate_name" label="分类" fixed></el-table-column>
                      <el-table-column prop="status" label="状态" sortable>
                        <template slot-scope="scope">
                          <el-tag v-if="scope.row.status == 1" type="success" size="mini">正常</el-tag>
                          <el-tag v-else-if="scope.row.status == 2" type="info" size="mini">下架</el-tag>
                        </template>
                      </el-table-column>
                      <el-table-column prop="thum" label="缩略图">
                        <template slot-scope="scope">
                          <img :src="scope.row.thum" style="max-width: 60%;">
                        </template>
                      </el-table-column>
                      <el-table-column prop="sell_price" label="价格" sortable>
                        <template slot-scope="scope">
                          <span style="font-weight: bold;color: #df0303">￥{{scope.row.sell_price}}</span>
                        </template>
                      </el-table-column>
                      <el-table-column prop="stock" label="库存" sortable></el-table-column>
                      <el-table-column prop="sell_num" label="销量" sortable></el-table-column>
                      <el-table-column label="操作" width="150" fixed="right">
                        <template slot-scope="scope">
                          <el-button @click="handleClick(scope.row, 'edit')" type="primary" size="small" icon="el-icon-edit-outline" plain></el-button>
                          <el-button @click="handleClick(scope.row, 'del')" type="danger" size="small" icon="el-icon-delete" plain></el-button>
                        </template>
                      </el-table-column>
                    </el-table>
                  </template>
                  <!-- 分页 -->
                  <template>
                    <div class="block" style="margin-top: 20px;">
                      <el-pagination @size-change="handleSizeChange" @current-change="handleCurrentChange" :current-page="currentPage" :page-sizes="pageSize"
                        :page-size="currentPageSize" layout="total, sizes, prev, pager, next, jumper" :total="total">
                      </el-pagination>
                    </div>
                  </template>
                </el-card>
              </el-col>
            </el-row>
            <!-- dialog -->
            <el-dialog title="商品编辑" :visible.sync="dialogVisible" fullscreen :before-close="handleClose">
              <el-collapse v-model="activeCollapseName" accordion>
                <el-collapse-item title="基本信息" name="1">
                  <el-row>
                    <el-col :span="18" :offset="3">
                      <el-card>
                        <el-form size="medium" ref="goodsBasicForm" :model="selectGoods" label-width="80px" label-position="left" :rules="goodsRules">
                          <el-form-item label="商品分类">
                            <el-cascader change-on-select v-model="goods_cate_ids" :options="cates"></el-cascader>
                          </el-form-item>
                          <el-form-item label="商品名称">
                            <el-input v-model="selectGoods.name"></el-input>
                          </el-form-item>
                          <el-form-item label="商品简介">
                            <el-input v-model="selectGoods.intro" type="textarea"></el-input>
                          </el-form-item>
                          <el-form-item label="商品状态" prop="status">
                            <el-radio v-model="selectGoods.status" :label="1">上线</el-radio>
                            <el-radio v-model="selectGoods.status" :label="2">下线</el-radio>
                          </el-form-item>
                          <el-row :gutter="30">
                            <el-col :span="6">
                              <el-form-item label="销售价格" prop="sell_price" label-width="80px">
                                <el-input v-model="selectGoods.sell_price" clearable></el-input>
                              </el-form-item>
                            </el-col>

                            <el-col :span="6">
                              <el-form-item label="库存" prop="stock" label-width="80px">
                                <el-input v-model="selectGoods.stock" clearable></el-input>
                              </el-form-item>
                            </el-col>
                            <el-col :span="6">
                              <el-form-item label="重量(g)" prop="weight">
                                <el-input v-model="selectGoods.weight" clearable></el-input>
                              </el-form-item>
                            </el-col>

                            <el-col :span="6">
                              <el-form-item label="购买赠送积分" prop="">
                                <el-input v-model="selectGoods.buy_get_score" clearable></el-input>
                              </el-form-item>
                            </el-col>

                            <!-- <el-col :span="6">
                              <el-form-item label="红包价" prop="red_price">
                                <el-input v-model="selectGoods.red_price" clearable></el-input>
                              </el-form-item>
                            </el-col> -->
                            <!-- <el-col :span="6">
                              <el-form-item label="成本价" prop="cost_price">
                                <el-input v-model="selectGoods.cost_price" clearable></el-input>
                              </el-form-item>
                            </el-col> -->
                            <!-- <el-col :span="6">
                              <el-form-item label="市场价" prop="market_price">
                                <el-input v-model="selectGoods.market_price" clearable></el-input>
                              </el-form-item>
                            </el-col> -->
                          </el-row>
                          <!-- <el-row :gutter="30"> -->
                            
                            <!-- <el-col :span="6">
                              <el-form-item label="商品编码" prop="goods_no">
                                <el-input v-model="selectGoods.goods_no" clearable></el-input>
                              </el-form-item>
                            </el-col>
                            <el-col :span="6">
                              <el-form-item label="商品条码" prop="goods_code">
                                <el-input v-model="selectGoods.goods_code" clearable></el-input>
                              </el-form-item>
                            </el-col> -->
                          <!-- </el-row> -->
                          <el-row :gutter="30">
                            <el-col :span="6">
                              <el-form-item label="销售量" prop="sell_num" label-width="80px">
                                <el-input v-model="selectGoods.sell_num" clearable></el-input>
                              </el-form-item>
                            </el-col>
                            <el-col :span="6">
                              <el-form-item label="点击量" prop="click_num">
                                <el-input v-model="selectGoods.click_num" clearable></el-input>
                              </el-form-item>
                            </el-col>
                            <el-col :span="6">
                              <el-form-item label="收藏量" prop="collect_num">
                                <el-input v-model="selectGoods.collect_num" clearable></el-input>
                              </el-form-item>
                            </el-col>
                            <el-col :span="6">
                              <el-form-item label="商品排序" prop="sort">
                                <el-input v-model="selectGoods.sort" clearable></el-input>
                              </el-form-item>
                            </el-col>
                          </el-row>
                          <el-form-item label="是否置顶" prop="is_top">
                            <el-switch v-model="selectGoods.is_top"></el-switch>
                          </el-form-item>
                          <el-form-item label="是否为虚拟商品" prop="is_virtual">
                            <el-switch v-model="selectGoods.is_virtual"></el-switch>
                          </el-form-item>
                          <!-- <el-form-item label="推荐位" prop="recoList">
                            <el-checkbox-group v-model="selectGoods.tags">
                              <el-checkbox label="精品"></el-checkbox>
                              <el-checkbox label="新品"></el-checkbox>
                              <el-checkbox label="热销品"></el-checkbox>
                              <el-checkbox label="折扣"></el-checkbox>
                              <el-checkbox label="清仓"></el-checkbox>
                            </el-checkbox-group>
                          </el-form-item> -->

                          <!-- 自定义商品标签 -->
                          <el-form-item label="商品标签" prop="tag_ids">
                            <el-checkbox-group v-model="selectGoods.tag_ids">
                              <el-checkbox :value="tag.id" :label="tag.id" v-for="(tag, tagKey) in goods_tags" :key="tagKey">{{tag.name}}</el-checkbox>
                            </el-checkbox-group>
                          </el-form-item>
                        </el-form>
                      </el-card>
                    </el-col>
                  </el-row>
                </el-collapse-item>
                <el-collapse-item title="商品图集" name="2">
                  <el-row>
                    <el-col :span="12" :offset="6">
                      <el-card>
                        <div slot="header">
                          <span>缩略图</span>
                        </div>
                        <ul class="el-upload-list el-upload-list--picture-card" v-if="selectGoods.thum">
                          <li class="el-upload-list__item is-ready">
                            <img :src="selectGoods.thum" alt="" class="el-upload-list__item-thumbnail">
                            <span class="el-upload-list__item-actions">
                              <span class="el-upload-list__item-edit" @click="fileClick('imgAdd');">
                                <i class="el-icon-edit"></i>
                              </span>
                              <span class="el-upload-list__item-edit" @click="viewBigImg(selectGoods.thum)">
                                <i class="el-icon-view"></i>
                              </span>
                            </span>
                          </li>
                        </ul>
                        <div v-else class="el-upload el-upload--picture-card" @click="fileClick('imgAdd');">
                          <i class="el-icon-plus"></i>
                        </div>
                      </el-card>
                      <el-card style="margin-top:20px;">
                        <div slot="header">
                          <span>图集</span>
                          <el-button style="float: right; padding: 3px 0" type="text" @click="fileClick('imgsAdd');">增加图集图片</el-button>
                        </div>
                        <ul class="el-upload-list el-upload-list--picture-card">
                          <li class="el-upload-list__item is-ready" v-show="img != ''" v-for="(img, imgKey) in selectGoods.imgs" :key="imgKey">
                            <img :src="img" alt="" class="el-upload-list__item-thumbnail">
                            <span class="el-upload-list__item-actions">
                              <span class="el-upload-list__item-edit" @click="fileClick('imgEdit', imgKey);">
                                <i class="el-icon-edit"></i>
                              </span>
                              <span class="el-upload-list__item-delete" @click="selectGoods.imgs.splice(imgKey, 1)">
                                <i class="el-icon-delete"></i>
                              </span>
                              <span class="el-upload-list__item-edit" @click="viewBigImg(img)">
                                <i class="el-icon-view"></i>
                              </span>
                            </span>
                          </li>
                        </ul>
                      </el-card>
                    </el-col>
                  </el-row>
                </el-collapse-item>
                <el-collapse-item title="商品属性" name="3">
                  <el-row>
                    <el-col :span="12" :offset="6">
                      <el-form size="medium" ref="goodsAttrsForm" :model="selectGoods" label-position="left" label-width="80px">
                        <el-form-item label="属性模板">
                          <el-select v-model="selectAttrTmpIndex">
                            <el-option v-for="(attrTmp, attrKey) in attrTemplates" :key="attrKey" :label="attrTmp.name" :value="attrKey"></el-option>
                          </el-select>
                        </el-form-item>
                        <el-card>
                          <div slot="header">
                            <span>属性项</span>
                            <el-button style="float: right; padding: 3px 0" type="text" @click="editContent('attr_info')">编辑属性项</el-button>
                          </div>
                          <el-form-item v-for="(cont, contKey) in selectGoods.attr_info" :key="contKey" :label="cont.name">
                            <el-radio v-for="(option ,optionKey) in cont.options" v-model="selectGoods.attr_info[contKey].value" :key="optionKey" :label="option">{{option}}</el-radio>
                          </el-form-item>
                        </el-card>
                      </el-form>
                    </el-col>
                  </el-row>
                </el-collapse-item>
                <el-collapse-item title="商品规格" name="4">
                  <el-row>
                    <el-col :span="8" :offset="2">
                      <el-form size="medium" ref="goodsSpecsForm" :model="selectGoods" label-position="left" label-width="80px">
                        <el-form-item label="规格模板">
                          <el-select v-model="selectSpecTmpIndex">
                            <el-option v-for="(specTmp, specKey) in specTemplates" :key="specKey" :label="specTmp.name" :value="specKey"></el-option>
                          </el-select>
                        </el-form-item>
                        <el-card>
                          <div slot="header">
                            <span>规格项</span>
                            <el-button style="float: right; padding: 3px 0" type="text" @click="editContent('spec_info')">编辑规格项</el-button>
                          </div>
                          <el-form-item v-for="(cont, contKey) in selectGoods.spec_info" :key="contKey" :label="cont.name">
                            <el-tag v-for="(option ,optionKey) in cont.options" :key="optionKey" style="margin-right:10px;">{{option}}</el-tag>
                          </el-form-item>
                        </el-card>
                      </el-form>
                    </el-col>
                  </el-row>
                  <el-row style="margin-top: 20px;">
                    <el-col :span="20" :offset="4">
                      <el-card>
                        <div slot="header">
                          <span>规格组</span>
                        </div>
                        <!-- 商品规格组合 -->
                        <div class="el-table el-table--fit el-table--border el-table--enable-row-hover el-table--enable-row-transition" style="width: 100%;">
                          <div class="el-table__body-wrapper is-scrolling-none">
                            <table cellspacing="0" cellpadding="0" border="0" class="el-table__body">
                              <thead class="has-gutter">
                                <tr class="" style="width: 9.5%">
                                  <th colspan="2" rowspan="1" class="is-leaf">
                                    <div class="cell">规格项</div>
                                  </th>
                                  <th colspan="1" rowspan="1" class="is-leaf">
                                    <div class="cell">库存
                                      <i class="el-icon-caret-bottom" style="cursor: pointer;" @click="quickSetSpec('stock')"></i>
                                      <el-input size="mini" v-model="quickSpecData.stock"></el-input>
                                    </div>
                                  </th>
                                  <th colspan="1" rowspan="1" class="is-leaf">
                                    <div class="cell">销售价格
                                      <i class="el-icon-caret-bottom" style="cursor: pointer;" @click="quickSetSpec('sell_price')"></i>
                                      <el-input size="mini" v-model="quickSpecData.sell_price"></el-input>
                                    </div>
                                  </th>
                                  <!-- <th colspan="1" rowspan="1" class="is-leaf">
                                    <div class="cell">市场价格
                                      <i class="el-icon-caret-bottom" style="cursor: pointer;" @click="quickSetSpec('market_price')"></i>
                                      <el-input size="mini" v-model="quickSpecData.market_price"></el-input>
                                    </div>
                                  </th>
                                  <th colspan="1" rowspan="1" class="is-leaf">
                                    <div class="cell">成本价格
                                      <i class="el-icon-caret-bottom" style="cursor: pointer;" @click="quickSetSpec('cost_price')"></i>
                                      <el-input size="mini" v-model="quickSpecData.cost_price"></el-input>
                                    </div>
                                  </th>
                                  <th colspan="1" rowspan="1" class="is-leaf">
                                    <div class="cell">红包价格
                                      <i class="el-icon-caret-bottom" style="cursor: pointer;" @click="quickSetSpec('red_price')"></i>
                                      <el-input size="mini" v-model="quickSpecData.red_price"></el-input>
                                    </div>
                                  </th>
                                  <th colspan="1" rowspan="1" class="is-leaf">
                                    <div class="cell">商品编码
                                      <i class="el-icon-caret-bottom" style="cursor: pointer;" @click="quickSetSpec('goods_no')"></i>
                                      <el-input size="mini" v-model="quickSpecData.goods_no"></el-input>
                                    </div>
                                  </th>
                                  <th colspan="1" rowspan="1" class="is-leaf">
                                    <div class="cell">商品条码
                                      <i class="el-icon-caret-bottom" style="cursor: pointer;" @click="quickSetSpec('goods_code')"></i>
                                      <el-input size="mini" v-model="quickSpecData.goods_code"></el-input>
                                    </div>
                                  </th> -->
                                  <th colspan="1" rowspan="1" class="is-leaf">
                                    <div class="cell">重量(g)
                                      <i class="el-icon-caret-bottom" style="cursor: pointer;" @click="quickSetSpec('weight')"></i>
                                      <el-input size="mini" v-model="quickSpecData.weight"></el-input>
                                    </div>
                                  </th>
                                  <th colspan="1" rowspan="1" class="is-leaf">
                                    <div class="cell">缩略图
                                      <i class="el-icon-caret-bottom" style="cursor: pointer;" @click.stop="quickSetSpec('thum')"></i>
                                      <div v-show="quickSpecData.thum" style="text-align: center;" @click.stop="fileClick('quickSpecDataThum')">
                                        <img :src="quickSpecData.thum" style="max-width: 100%;">
                                      </div>
                                      <div v-show="!quickSpecData.thum" style="text-align: center;display:block;" @click.stop="fileClick('quickSpecDataThum')">
                                        <i class="el-icon-upload"></i>
                                      </div>
                                    </div>
                                  </th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr class="el-table__row" v-for="(dynamicSpec, dynamicSpecKey) in selectGoods.spec_group_info" :key="dynamicSpecKey">
                                  <td class="" style="width: 9.5%" colspan="2">
                                    <div class="cell" style="width:100%">
                                      <el-tag type="mini"> {{dynamicSpec.spec_option_group}}</el-tag>
                                    </div>
                                  </td>
                                  <td class="" style="width: 9.5%">
                                    <div class="cell">
                                      <el-input size="mini" v-model="dynamicSpec.stock" style="width:100%"></el-input>
                                    </div>
                                  </td>
                                  <td class="" style="width: 9.5%">
                                    <div class="cell">
                                      <el-input size="mini" v-model="dynamicSpec.sell_price" style="width:100%"></el-input>
                                    </div>
                                  </td>
                                  <!-- <td class="" style="width: 9.5%">
                                    <div class="cell">
                                      <el-input size="mini" v-model="dynamicSpec.market_price" style="width:100%"></el-input>
                                    </div>
                                  </td>
                                  <td class="" style="width: 9.5%">
                                    <div class="cell">
                                      <el-input size="mini" v-model="dynamicSpec.cost_price" style="width:100%"></el-input>
                                    </div>
                                  </td>
                                  <td class="" style="width: 9.5%">
                                    <div class="cell">
                                      <el-input size="mini" v-model="dynamicSpec.red_price" style="width:100%"></el-input>
                                    </div>
                                  </td>
                                  <td class="" style="width: 9.5%">
                                    <div class="cell">
                                      <el-input size="mini" v-model="dynamicSpec.goods_no" style="width:100%"></el-input>
                                    </div>
                                  </td>
                                  <td class="" style="width: 9.5%">
                                    <div class="cell">
                                      <el-input size="mini" v-model="dynamicSpec.goods_code" style="width:100%"></el-input>
                                    </div>
                                  </td> -->
                                  <td class="" style="width: 9.5%">
                                    <div class="cell">
                                      <el-input size="mini" v-model="dynamicSpec.weight" style="width:100%"></el-input>
                                    </div>
                                  </td>
                                  <td class="" style="width: 9.5%" style="text-align: center;" @click="fileClick('specGroupInfoThum', dynamicSpecKey)">
                                    <div v-show="dynamicSpec.thum" style="text-align: center;">
                                      <img v-show="dynamicSpec.thum" :src="dynamicSpec.thum" style="max-width: 45%;">
                                    </div>
                                    <div style="text-align: center;" v-show="!dynamicSpec.thum">
                                      <i class="el-icon-upload"></i>
                                    </div>
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </el-card>
                    </el-col>
                  </el-row>
                </el-collapse-item>
                <el-collapse-item title="商品运费" name="5">
                  <el-row>
                    <el-col :span="12" :offset="6">
                      <el-card>
                        <el-form size="medium" ref="goodsFreightForm" :model="selectGoods" label-position="left" label-width="80px">
                          <el-form-item label="运费模板">
                            <el-select v-model="selectGoods.freight_template_id">
                              <el-option v-for="(frightTmp, freightKey) in freightTemplates" :key="freightKey" :label="frightTmp.name" :value="frightTmp.id"></el-option>
                            </el-select>
                          </el-form-item>
                        </el-form>
                      </el-card>
                    </el-col>
                  </el-row>
                </el-collapse-item>
                <el-collapse-item title="商品详情" name="6">
                  <el-row>
                    <el-col :span="12" :offset="6">
                      <script id="container" type="text/plain"></script>
                    </el-col>
                  </el-row>
                </el-collapse-item>
              </el-collapse>

              <!-- 模板编辑dialog -->
              <el-dialog title="模板编辑" :visible.sync="innerDialogVisible" width="70%" append-to-body :close-on-click-modal="false">
                <div style="margin-bottom:20px">
                  <el-button type="primary" plain @click="addContent">增加选项</el-button>
                </div>
                <el-row :gutter="20">
                  <el-col :span="8" v-for="(cont, key) in selectTemplateContent" :key="key" style="margin-bottom: 20px;">
                    <el-card>
                      <div slot="header">
                        <span v-text="cont.name"></span>
                        <el-button style="float: right; padding: 3px 0" type="text" icon="el-icon-delete" @click="selectTemplateContent.splice(key, 1)"></el-button>
                      </div>
                      <el-form label-position="left" label-width="90">
                        <el-form-item v-for="(option, oKey) in cont.options" :key="oKey" :label="cont.name + '项' + (oKey + 1)">
                          <el-input clearable v-model="cont.options[oKey]" style="width: 60%;"></el-input>
                          <el-button style="float:right;" v-if="oKey != 0" @click="cont.options.splice(oKey, 1)">移除</el-button>
                        </el-form-item>
                      </el-form>
                      <el-button type="primary" size="medium" icon="el-icon-plus" circle plain @click="cont.options.push('')"></el-button>
                    </el-card>
                  </el-col>
                </el-row>
                <span slot="footer" class="dialog-footer">
                  <el-button @click="innerDialogVisible = false">取消</el-button>
                  <el-button type="primary" @click="updateTemplateContent">提交</el-button>
                </span>
              </el-dialog>
              <span slot="footer" class="dialog-footer">
                <el-button size="medium" @click="dialogVisible = false" plain>取消</el-button>
                <el-button size="medium" type="primary" @click="submit">提交</el-button>
              </span>
              <input @change="fileChange($event)" type="file" id="imgAdd" style="display: none">
              <input @change="fileChange($event)" type="file" id="imgsAdd" style="display: none" multiple>
            </el-dialog>
          </div>
        </main>
        {include file="footer" /}
      </section>
    </section>
  </section>
  <!-- 百度编辑器 -->
  <script type="text/javascript" src="/public/static/ueditor/ueditor.config.js"></script>
  <script type="text/javascript" src="/public/static/ueditor/ueditor.all.min.js"></script>
  <script type="text/javascript">
    let ue = {};
    let app = new Vue({
      el: '#app',
      data() {
        return {
          tableData: [],  //表格数据
          currentPage: parseInt(querystring.currentPage) || 1, //当前页
          currentPageSize: 20,  //当前页容量
          pageSize: [20, 40, 60, 80, 100, 200], //分页大小
          total: 0, //总页数
          multipleSelection: [],  //多选项
          searchData: {
            name: '',
            cate_id: ''
          },
          // 商品分类
          cates: [],
          cate_ids: [],
          // 属性模板
          attrTemplates: [],
          selectAttrTmpIndex: '',
          // 规格模板
          specTemplates: [],
          selectSpecTmpIndex: '',
          // 规格快速选项
          quickSpecData: {
            stock: 0,
            sell_price: 0,
            // market_price: 0,
            // cost_price: 0,
            // red_price: 0,
            weight: 0,
            // goods_no: '0',
            // goods_code: '0',
            thum: ''
          },
          // 运费模板
          freightTemplates: [],
          // dialog
          dialogVisible: false,
          selectGoods: {},
          goodsRules: [],
          goods_cate_ids: [],
          currentUploadType: '',
          currentUploadIndex: '',
          // collapse
          activeCollapseName: '1',
          // innerDialog
          innerDialogVisible: false,
          selectTemplateContent: [],
          selectTemplateType: '',
          goods_tags: [],
        }
      },
      methods: {
        // 点击代理
        handleClick(data, type, scope) {
          if (type == 'del') {
            this.$confirm('确认删除?', { type: 'warning' }).then(_ => {
              httpRequest('POST', 'api_goods/goods/delete', { id: data.id }).then(resp => {
                this.$message.success(resp.msg)
                this.tableData.splice(this.tableData.indexOf(data), 1);
              })
            }).catch(_ => {
              this.$message.info('操作已取消');
            })
          } else if (type === 'edit') {
            this.selectGoods = deepCopy(data);
            this.goods_cate_ids = packageCascaderSelecteData(this.cates, this.selectGoods.goods_cate_id);
            this.activeCollapseName = '1';
            this.dialogVisible = true;
            this.initUEditor(this.selectGoods.desc);
          }
        },
        // 跳页
        handleCurrentChange(val) {
          this.currentPage = val;
          this.loadTableData();
        },
        // 改变页容量
        handleSizeChange(val) {
          this.currentPageSize = val;
          this.loadTableData();
        },
        // 搜索
        search() {
          this.currentPage = 1;
          this.loadTableData();
        },
        // 重置
        refresh() {
          this.currentPage = 1;
          for (var key in this.searchData) {
            this.searchData[key] = ''
          }
          this.cate_ids = [];
          this.loadTableData();
        },
        // 多选监听
        handleSelectionChange(val) {
          this.multipleSelection = val;
        },
        // 批量操作
        multiOperate(type) {
          let ids = this.multipleSelection.map(item => item.id);
          this.$confirm('确认批量操作?', '提示', { type: 'warning' }).then(_ => {
            httpRequest('POST', 'api_goods/goods/batch_' + type, { id: ids }).then(resp => {
              this.$message.success(resp.msg);
              setTimeout(_ => {
                location.reload();
              }, 500);
            })
          }).catch(_ => {
            this.$message.info('操作已取消');
          });
        },
        // 新增
        goAdd() {
          this.selectGoods = {
            name: '',
            intro: '',
            status: 1,
            goods_cate_id: '',
            sell_price: 0,
            // red_price: 0,
            // cost_price: 0,
            // market_price: 0,
            stock: 0,
            weight: 0,
            // goods_no: '',
            // goods_code: '',
            sell_num: 0,
            buy_get_score: 0,
            click_num: 0,
            collect_num: 0,
            sort: 0,
            is_top: false,
            is_virtual: false,
            tags: [],
            tag_ids: [],
            thum: '',
            imgs: [],
            attr_info: [],
            spec_info: [],
            spec_group_info: [],
            freight_template_id: 0,
          };
          this.goods_cate_ids = [];
          this.activeCollapseName = '1';
          this.dialogVisible = true;
          this.initUEditor();
        },
        // 加载数据
        loadTableData() {
          httpRequest('POST', 'api_goods/goods/index', this.searchData, {
            'page-num': this.currentPage,
            'page-limit': this.currentPageSize
          }).then(resp => {
            this.tableData = resp.data;
            this.total = resp.page.data_count || 0;
          })
        },
        // dialog窗口关闭
        handleClose(done) {
          this.$confirm('确认关闭？')
            .then(_ => {
              done();
            })
            .catch(_ => { });
        },
        // 初始化 UEeditor
        initUEditor(content = '') {
          setTimeout(_ => {
            if (isEmptyObject(ue)) {
              ue = UE.getEditor('container', {
                autoHeightEnabled: false,
                autoFloatEnabled: false,
                initialFrameHeight: 600,
              });
              ue.ready(_ => {
                ue.setContent(content);
              })
            } else {
              setTimeout(_ => {
                ue.setContent(content)
              }, 100)
            }
          }, 200);
        },
        // 快速编辑规格
        quickSetSpec(type) {
          this.selectGoods.spec_group_info.forEach(t => {
            t[type] = this.quickSpecData[type]
          })
        },
        // 刷新规格组
        refreshSpecGroupInfo() {
          let pre = []; //前一次的组合结果
          this.selectGoods.spec_info.forEach((cont, index) => {
            let cur = [];  //当前次的组合结果
            this.selectGoods.spec_info[index].options.forEach(option => {
              if (index == 0) { //第一次直接保存
                pre.push({
                  spec_option_group: option,
                  stock: 0,
                  sell_price: 0,
                  // market_price: 0,
                  // cost_price: 0,
                  // red_price: 0,
                  weight: 0,
                  // goods_no: '0',
                  // goods_code: '0',
                  thum: ''
                })
              } else {
                // 非第一次则拼上前一次组合的id
                pre.forEach(h => {
                  cur.push({
                    spec_option_group: h.spec_option_group + '_' + option,
                    stock: 0,
                    sell_price: 0,
                    // market_price: 0,
                    // cost_price: 0,
                    // red_price: 0,
                    weight: 0,
                    // goods_no: '0',
                    // goods_code: '0',
                    thum: ''
                  })
                })
              }
            })
            if (index != 0) {
              // 将当前次的组合归档，继续进行下一组的遍历
              pre = deepCopy(cur);
            }
          })
          this.selectGoods.spec_group_info = pre;
        },
        fileClick(type, index) {
          this.currentUploadType = type;
          if (type == 'imgsAdd') {
            document.getElementById('imgsAdd').click();
          } else {
            if (type == 'imgEdit' || type == 'specGroupInfoThum' || type == 'quickSpecDataThum') {
              this.currentUploadIndex = index;
            }
            document.getElementById('imgAdd').click();
          }
        },
        fileChange(el) {
          Array.from(el.target.files).forEach(item => {
            let formData = new FormData();
            formData.append('file', item);
            formData.append('save_path', goodsImagesPath);
            formData.append('is_rename', 1);
            httpRequest('POST', 'api_systems/helper/upload_file', formData).then(resp => {
              if (this.currentUploadType == 'quickSpecDataThum') { // 快速编辑规格缩略图
                this.quickSpecData.thum = resp.data.host_file_path;
              } else if (this.currentUploadType == 'specGroupInfoThum') { // 规格组缩略图
                this.selectGoods.spec_group_info[this.currentUploadIndex].thum = resp.data.host_file_path;
              } else if (this.currentUploadType == 'imgAdd') { // 商品缩略图
                this.selectGoods.thum = resp.data.host_file_path;
              } else if (this.currentUploadType == 'imgsAdd') { //增加商品图集
                this.selectGoods.imgs.push(resp.data.host_file_path);
              } else if (this.currentUploadType == 'imgEdit') {  //编辑商品图集单个图片
                Vue.set(this.selectGoods.imgs, this.currentUploadIndex, resp.data.host_file_path)
              }
              // 清除选项框内容
              if (this.currentUploadType == 'imgsAdd') {
                var file = document.getElementById('imgsAdd');
              } else {
                var file = document.getElementById('imgAdd');
              }
              file.value = '';
            })
          })
        },
        editContent(type) {
          this.selectTemplateContent = deepCopy(this.selectGoods[type]);
          this.selectTemplateType = type;
          this.innerDialogVisible = true;
        },
        // 增加选项
        addContent() {
          this.$prompt('请输入选项名称', '提示', {
            inputPattern: /.+/,
            inputErrorMessage: '请填写选项名称'
          }).then(({ value }) => {
            if (this.selectTemplateContent.some(item => item.name == value)) {
              this.$message.error('名称已存在');
            } else {
              this.selectTemplateContent.push({
                name: value,
                options: [''],
              })
            }
          })
        },
        // 更新选项
        updateTemplateContent() {
          if (!this.selectTemplateContent.length) {
            this.$message.error('请添加选项');
            return;
          }
          if (this.selectTemplateContent.some(cont => cont.options.some(option => !option))) {
            this.$message.error('请填写完整的信息');
            return;
          }
          for (let i = 0; i < this.selectTemplateContent.length; i++) {
            let templateContet = this.selectTemplateContent[i];
            let assignObj = {}
            for (let j = 0; j < templateContet.options.length; j++) {
              let option = templateContet.options[j];
              if (assignObj[option]) {
                this.$message.error('【' + option + '】选项值已经存在');
                return;
              } else {
                assignObj[option] = true;
              }
            }
          }
          this.selectGoods[this.selectTemplateType] = deepCopy(this.selectTemplateContent);
          this.innerDialogVisible = false;

          if (this.selectTemplateType == 'spec_info') {
            this.refreshSpecGroupInfo();
          }
        },
        submit() {
          if (!this.selectGoods.name) {
            this.$message.error('请填写商品名称');
            return;
          }
          if (!this.selectGoods.goods_cate_id) {
            this.$message.error('请选择商品分类');
            return;
          }
          if (!this.selectGoods.sell_price) {
            this.$message.error('请填写商品价格');
            return;
          }
          if (!this.selectGoods.thum) {
            this.$message.error('请上传商品缩略图');
            return;
          }
          if (!this.selectGoods.imgs.length) {
            this.$message.error('请上传商品图集');
            return;
          }
          // 验证属性
          if (this.selectGoods.attr_info.some(item => !item.value)) {
            this.$message.error('请选择完整的属性项');
            return;
          }
          this.selectGoods.desc = ue.getContent();
          let router = this.selectGoods.id ? 'api_goods/goods/update' : 'api_goods/goods/save';
          httpRequest('POST', router, this.selectGoods).then(resp => {
            this.$message.success(resp.msg);
            setTimeout(_ => {
              location.reload();
            }, 500);
          })
        },
        viewBigImg(img){
          window.open(img);
        },
      },
      watch: {
        cate_ids(value) {
          this.searchData.goods_cate_id = value[value.length - 1];
        },
        goods_cate_ids(value) {
          this.selectGoods.goods_cate_id = value[value.length - 1];
        },
        selectAttrTmpIndex(value) {
          this.selectGoods.attr_info = deepCopy(this.attrTemplates[value].content.map(item => {
            item.value = '';
            return item;
          }))
        },
        selectSpecTmpIndex(value) {
          this.selectGoods.spec_info = deepCopy(this.specTemplates[value].content);
          this.refreshSpecGroupInfo();
        },
        'selectGoods.is_virtual'(value) {
          value && (this.selectGoods.freight_template_id = 0);
        }
      },
      mounted() {
        httpRequest('POST', 'api_goods/goods_cates/index_tree').then(resp => {
          this.cates = packageCascaderData(resp.data);
          this.loadTableData();
        })
        httpRequest('POST', 'api_goods/attr_templates/index').then(resp => {
          this.attrTemplates = resp.data;
          this.attrTemplates.unshift({
            id: -1,
            name: '无属性',
            content: [],
          })
        })
        httpRequest('POST', 'api_goods/spec_templates/index').then(resp => {
          this.specTemplates = resp.data;
          this.specTemplates.unshift({
            id: -1,
            name: '无规格',
            content: [],
          })
        })
        httpRequest('POST', 'api_goods/freight_templates/index').then(resp => {
          this.freightTemplates = resp.data
          this.freightTemplates.unshift({ id: 0, name: '免邮费' })
        })
        httpRequest('POST', 'api_goods/goods_tags/index').then(resp => {
          this.goods_tags = resp.data
        })
      }
    });
  </script>
</body>

</html>