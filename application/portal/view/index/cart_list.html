<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=no, width=device-width">
  <meta name="keywords" content="wancllshop">
  <title></title>
  <!-- 公共资源文件引入 -->
  <link rel="stylesheet" href="/public/static/common/css/loading.css" type="text/css">

  <link rel="stylesheet" href="/public/static/wap/aui/css/aui.css" type="text/css">
  <link rel="stylesheet" href="/public/static/wap/css/wap.css" type="text/css">
  <link rel="stylesheet" type="text/css" href="/public/static/wap/aui/css/aui-flex.css" />

  <!-- 图标库 -->
  <link rel="stylesheet" type="text/css" href="/public/static/common/css/ali_icon/iconfont.css" />

  <script src="/public/static/jquery-3.2.1.min.js" type="text/javascript"></script>
  <script src="/public/static/layer-v3.1.1/layer/layer.js" type="text/javascript"></script>
  <script src="/public/static/vue/vue-2.5.15/vue.min.js" type="text/javascript"></script>


  <script src="/public/static/common/script/common.js" type="text/javascript"></script>
  <script src="/public/static/common/script/config.js" type="text/javascript"></script>
  <script src="/public/static/common/script/wapRouter.js" type="text/javascript"></script>

  <script src="/public/static/axios/axios.min.js"></script>
  <script src="/public/static/common/script/httpPromise.js"></script>
  <link rel="icon" id="icon-img" href="" type="image/x-icon"/>


  <!-- <script>
    document.title = getStorage('systemParams').system_title || ''
    document.getElementById("icon-img").href = getStorage('systemParams').web_icon;
  </script> -->
<link rel="stylesheet" href="/public/static/portal/css/shouye.css">

<style>
    .cart_isselect {
        width: 48px;
        margin: auto;
    }

    .cart_info {
        margin: auto
    }

    .cart_num {
        width: 140px;
        margin: auto;
    }

    .cart_price {
        width: 200px;
        margin: auto;
    }

    .cart_type {
        width: 140px;
        margin: auto;
    }

    .cart_list_box {
        height: 106px;
        width: 106px;
    }

    .cart_list_box img {
        width: 100%;
    }

    .cart_info_text {
        width: 225px;
        text-align: left
    }

    .cart-create span {
        display: inline-block;

    }

    .cart-create {}

    .cart_create_order {
        padding: 0 30px;
        font-size: 16px;
        border-radius: 50px;
        line-height: 36px;
        margin-left: 50px;
    }
    .cart_sizeinfo{
        position: absolute;
        z-index: 99;
    }
    .cart_null_img{
        margin-top:200px; 
    }
    .cart_null_text{
        width: 100%;
        position: absolute;
         top: 252px;
         color: #666;
    }
    .cart_null_box{
        margin-bottom: 150px;
    }
    .Xcontent .cont-right{width: auto;}
    .Xcontent .cont-right .type-list2 .type-right{
        width: auto;
    }
    .Xcontent{height: auto;}
    .selectSpecactive{overflow: hidden;}
    .cart_sizeinfoactive{
       border: 1px solid #dedede
        }
</style>
</head>

<body>
    {include file="/index/header" /}
    <div id="app">
        <div class="w1200 margin-tt-15 over  black-text">
                <div class="left">
                        <!-- 个人信息卡 -->
                        <div class=" card-title-wrap">
                            <img  src="/public/static/portal/img/title-back.png" class="responsive-img">
                            <div class="margin-10 over card-text-wrap">
                                <div class="ridius-img left margin-15">
                                    <img :src="user.avatar" alt="">
                                </div>
                                <div class="left margin-top-15">
                                    <div class="font-size-18 margin-top-15 white-text"  v-text="user.nick_name || user.mobile"></div>
                                    <div class="blue lighten-1 margin-top-5" style="border-radius: 4px;padding: 2px 4px;">
                                        <img src="/public/static/portal/img/lr.png" alt="">
                                        <span class="font-size-12 white-text" v-text="level"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="rate-line font-size-12 blue-text text-lighten-5">
                                <div class="rataing-nember  margin-15" v-text=" '成长值  ' + score"></div>
                                <div class="ratas-nember right"></div>	
                            </div>
                        </div>
                        <div class="white grey-text text-darken-3 margin-top-15" style="border-radius: 5px">
                            <div class="card-right-nav-box  margin-10 padding-tt-10" style="border: none">
                                <div class="card-right-nav">
                                    <div class="font-size-18 over margin-tt-10">
                                        <i class="iconfont icon-icon_order left text-lighten-1" style="font-size:24px; margin-right: 5px;height: 30px;line-height: 30px;"></i>
                                        <span class="left margin-top-5">交易管理</span>
                                    </div>
                                    <ul class="card-right-nav-ul">
                                        <li class="margin-tt-13" @click="goto('cart_list')">购物车</li>
                                        <li class="margin-tt-13" @click="goto('order_list')">我的订单</li>
                                        <li class="margin-tt-13" @click="goto('comment_list')">我的评价</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-right-nav-box  margin-10 padding-tt-10">
                                <div class="card-right-nav">
                                    <div class="font-size-18 over margin-tt-10">
                                            <i class="iconfont icon-icon_order left text-lighten-1" style="font-size:24px; margin-right: 5px;height: 30px;line-height: 30px;"></i>
                                        <span class="left margin-top-5">账号管理</span>
                                    </div>
                                    <ul class="card-right-nav-ul">
                                        <li class="margin-tt-13" @click="goto('setting')">个人信息</li>
                                        <li class="margin-tt-13" @click="goto('account')">账号安全</li>
                                        <li class="margin-tt-13" @click="goto('idcard_auth')" >实名认证</li>
                                        <li class="margin-tt-13" @click="goto('address_list')">地址管理</li>
                                        <li class="margin-tt-13"  @click="goto('collection_list')">我的收藏</li>
                                        <li class="margin-tt-13"  @click="goto('level')">成长值<span class="blue-text text-lighten-1" v-text="'('+score+')'"></span></li>
                                        <li class="margin-tt-13"  @click="goto('bind')">第三方账户</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-right-nav-box margin-10 padding-tt-10">
                                <div class="card-right-nav">
                                    <div class="font-size-18 over margin-tt-10">
                                            <i class="iconfont icon-icon_order left text-lighten-1" style="font-size:24px; margin-right: 5px;height: 30px;line-height: 30px;"></i>
                                        <span class="left margin-top-5">资产管理</span>
                                    </div>
                                    <ul class="card-right-nav-ul">
                                        <li class="margin-tt-13" @click="goto('wallet')">我的钱包</li>
                                        <li class="margin-tt-13" @click="goto('bankcard_list')">我的银行卡</li>
                                        <li class="margin-tt-13" @click="goto('my_coupon_list')">我的优惠券<span class="blue-text text-lighten-2" v-if="coupons.length" v-text=" '('+ coupons.length + ')'"></span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
            <div class="right right-content">
                <div class="padding-15 white">
                    <div class="font-size-16 grey-text text-darken-3 padding-tt-15 border-btn" style="border-bottom: 2px solid rgb(238, 238, 238); padding-bottom: 15px !important;">购物车</div>
                    <div class="margin-tt-15 flex grey-text text-darken-3 grey lighten-4">
                        <div class="cart_isselect center" @click="selectAll()">
                            <i class="iconfont icon-yuanxingweixuanzhong" v-show="!isSelectedAll" style="font-size: 22px"></i>
                            <i class="iconfont icon-roundcheckfill blue-text" v-show="isSelectedAll" style="font-size: 22px;"></i>
                        </div>
                        <div class="flex1 center cart_info">
                            <div class="left">
                                全选
                            </div>
                            商品（单价）
                        </div>
                        <div class="cart_num center">
                            数量
                        </div>
                        <div class="cart_price center">
                            总计（￥）
                        </div>
                        <div class="cart_type center">
                            操作
                        </div>
                    </div>
                    <div v-if="haveNoData" class="over margin-btn-15">
                        <div class="center relative margin-btn-15">
                            <div class="cart_null_text">空空如也~</div>
                            <img  src="/public/static/portal/img/404.png" alt="" class="responsive-img cart_null_img"><br>
                            <div class="setting-go-btn white-text blue inline-black margin-15 cart_null_box pointer" @click="goto('index')">去逛逛</div>
                        </div>
                    </div>
                    <div v-else v-for="(cart,cartkey) in carts" :key="cartkey">
                        <div class="flex  padding-tt-15 border-grey margin-tt-10">
                            <div class="cart_isselect center" @click="changeSelected(cart)">
                                <i class="iconfont icon-yuanxingweixuanzhong" v-show="!cart.isSelected" style="font-size: 22px"></i>
                                <i class="iconfont icon-roundcheckfill blue-text" v-show="cart.isSelected" style="font-size: 22px;"></i>
                            </div>
                            <div class="flex1 center cart_info">
                                <div class="left border-grey cart_list_box center over margin-lr-10">
                                    <img :src="cart.goods_info.thum" alt="" @click="goto('goods_detail',{goodsId:cart.goods_id})">
                                </div>
                                <div class="left padding-10 cart_info_text relative" :class="{selectSpecactive:cart.selectSpecs}">
                                    <div class="" v-text="cart.goods_info.name"></div>
                                    <div class="margin-btn-5"  v-text="cart.goods_info.intro"></div>
                                    <div class="font-size-10" v-if="cart.spec_group_info.spec_option_group" v-text=" '￥' + cart.spec_group_info.sell_price"></div>
                                    <div class="font-size-10" v-else v-text=" '￥' + cart.goods_info.sell_price"></div>
                                    <div class="border-grey"    v-if="cart.spec_group_info.spec_option_group"   @click="selectSpecbox(cart)">
                                        {{'规格: ' + cart.spec_group_info.spec_option_group}} <span class="right blue-text pointer">点击修改</span>
                                    </div>
                                    <div class="Xcontent">
                                        <div class="cart_sizeinfo cont-right white ":class="{cart_sizeinfoactive:!cart.selectSpecs}">
                                            <div class=" clearfix type-list2 padding-left-10" v-for="(name, nameKey) in spec_template.names" :key="nameKey">
                                                <p class="left type-title font-size-14"  v-text="name.name" ></p>
                                                <div class="type-right clearfix">
                                                    <div class="left cm-type  transition pointer" v-for="(option, optionKey) in cart.goods_info.goods_spec_info[name.id]"
                                                    :key="optionKey" v-text="option.option" @click="selectSpec(option, name ,cartkey)" :class="[{'on': option.isSelected},{'on': option.isSelected}]" > </div> 
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="cart_num center padding-lr-15">
                                <i class="left pointer iconfont icon-jian-tianchong grey-text" style="font-size: 30px" @click.stop="changeNum(cart,-1)"></i>
                                <span class="center" style="line-height: 45px;" v-text=" '×'+ cart.num"></span>
                                <i class="pointer right iconfont icon-jia-tianchong blue-text" style="font-size: 30px;" @click.stop="changeNum(cart,1)"></i>

                            </div>
                            <div class="cart_price center">
                                <div class="" v-if="cart.spec_group_info.spec_option_group" v-text="cart.num * cart.spec_group_info.sell_price + '元'"></div>
                                <div class="" v-else v-text="cart.num * cart.goods_info.sell_price + '元'"></div>
                                <div class="grey-text "></div>
                            </div>
                            <div class="cart_type center">
                                <div class="grey-text pointer" @click="addCollections(cart.goods_info.id)">移入收藏夹</div>
                                <div class="grey-text pointer" @click="removeCarts(cart.id)">删除</div>
                            </div>
                        </div>
                    </div>
                    <div class="grey-text text-darken-3">
                        <span class="pointer collection-page margin-5 inline-black border-grey pointer"  v-for="(page,key) in pages" :key="key" @click="gopage(page)":class="{active: (activeclass == page)}"  v-text="page"></span>
                    </div>
                    <div class="grey lighten-4 flex cart-create padding-tt-15">
                            <div class="cart_isselect center" @click="selectAll()">
                                    <i class="iconfont icon-yuanxingweixuanzhong" v-show="!isSelectedAll" style="font-size: 22px"></i>
                                    <i class="iconfont icon-roundcheckfill blue-text" v-show="isSelectedAll" style="font-size: 22px;"></i>
                                </div>
                        <span class="bt" style="margin: auto 7px;" v-text=" '已选' + totalnum">已选(2)</span>
                        <span class="bt" style="margin: auto 30px" @click="removeCart()">删除</span>
                        <span class="bt" style="margin: auto 30px" @click="addCollection()">移入收藏夹</span>
                        <span class="grey-text " style="margin: auto 0 auto 100px;" v-text=" '共' + totalnum + '件商品' "></span>
                        <span style="margin:auto 0 ">合计：</span>
                        <span class="font-size-24 red-text" v-text=" '￥' + totalPrice" style="width: 150px;"></span>
                        <span class="blue white-text cart_create_order bt" @click="checkout()" >提交订单</span>
                    </div>
                </div>
                <div class="margin-top-15">
                    <img src="/public/static/portal/img/lien-img.png" alt="" class="responsive-img">
                </div>
            </div>
        </div>
        <div class="w1200 white over margin-btn-15">
            <div class="foot-list-title black-text text-lighten-1 margin-15 font-size-18 padding-left-15">猜你喜欢</div>
            <div class="foot-list margin-15 over">
                <div class="left foot-list-box">
                    <img src="/public/static/portal/img/goods-1.png" class="responsive-img">
                    <div class="padding-10">
                        <div class="font-size-16 black-text">COCCINELLF DESIGN系列 女士长款钱包 意大利</div>
                        <div class="margin-top-10 over">
                            <div class="left">
                                <span class="red-text font-size-16">￥200</span>
                                <span class="font-size-10 grey-text lighten-1">￥389</span>
                            </div>
                            <div class="right font-size-12 grey-text lighten-1">月销量：2530</div>
                        </div>
                    </div>
                </div>
                <div class="left foot-list-box">
                    <img src="/public/static/portal/img/goods-1.png" class="responsive-img">
                    <div class="padding-10">
                        <div class="font-size-16 black-text">COCCINELLF DESIGN系列 女士长款钱包 意大利</div>
                        <div class="margin-top-10 over">
                            <div class="left">
                                <span class="red-text font-size-16">￥200</span>
                                <span class="font-size-10 grey-text lighten-1">￥389</span>
                            </div>
                            <div class="right font-size-12 grey-text lighten-1">月销量：2530</div>
                        </div>
                    </div>
                </div>
                <div class="left foot-list-box">
                    <img src="/public/static/portal/img/goods-1.png" class="responsive-img">
                    <div class="padding-10">
                        <div class="font-size-16 black-text">COCCINELLF DESIGN系列 女士长款钱包 意大利</div>
                        <div class="margin-top-10 over">
                            <div class="left">
                                <span class="red-text font-size-16">￥200</span>
                                <span class="font-size-10 grey-text lighten-1">￥389</span>
                            </div>
                            <div class="right font-size-12 grey-text lighten-1">月销量：2530</div>
                        </div>
                    </div>
                </div>
                <div class="left foot-list-box">
                    <img src="/public/static/portal/img/goods-1.png" class="responsive-img">
                    <div class="padding-10">
                        <div class="font-size-16 black-text">COCCINELLF DESIGN系列 女士长款钱包 意大利</div>
                        <div class="margin-top-10 over">
                            <div class="left">
                                <span class="red-text font-size-16">￥200</span>
                                <span class="font-size-10 grey-text lighten-1">￥389</span>
                            </div>
                            <div class="right font-size-12 grey-text lighten-1">月销量：2530</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {include file="index/footer" /}
    <script>
        var app = new Vue({
            el: '#app',
            data: {
                user:user,
                activeFooterIndex: 3,
                carts: [],
                haveNoData: false,
                isEditCart: true,
                pages:[],
                activeclass:1,
                spec_template: [],
                score:'',
                level:'',
                coupons:'',
                select_spec_group_info:''
            },
            methods: {
                //规格
                selectSpec: function (option, name ,cartkey) { 
          this.carts[cartkey].goods_info.goods_spec_info[name.id].forEach(function (item) {
            Vue.set(item, 'isSelected', false);
          })
          Vue.set(option, 'isSelected', true);

          // 组合已经选择的规格项，进行自然序排序，与对应的规格组进行对比
          var ids = [];
          for (var key in this.carts[cartkey].goods_info.goods_spec_info) {
            this.carts[cartkey].goods_info.goods_spec_info[key].forEach(function (item) {
              if (item.isSelected) {
                ids.push(item.id)
              }
            })
          }
          ids = ids.sort().toString();
          console.log(ids);
          this.carts[cartkey].goods_info.goods_spec_group_info.forEach(function (item) {
            if (ids == item.spec_option_ids) {
              app.carts[cartkey].spec_group_info = item;
            }
          }) 

        //    app.select_spec_group_info = JSON.parse(JSON.stringify(this.select_spec_group_info));
        //    app.carts = JSON.parse(JSON.stringify(this.carts)); 
        },
                changeNum: function (cart, num) {
                    if (num == -1 && cart.num < 2) {
                        return;
                    }
                    httpRequest('POST', 'api_goods/carts/update', {
                        id: cart.id,
                        goods_id: cart.goods_id,
                        num: cart.num + num,
                        spec_group_id: cart.spec_group_id,
                    },function (resp) {
                        cart.num += num;
                    })
                },
                // 全选
                selectAll: function () {
                    var isSelectedAll = this.isSelectedAll;
                    this.carts.forEach(function (item) {
                        item.isSelected = !isSelectedAll;
                    })
                },
                // 购物车状态
                changeSelected: function (cart) {
                    cart.isSelected = !cart.isSelected

                },
                // 批量删除购物车
                removeCart: function () {
                    var ids = [];
                    this.carts.forEach(function (item) {
                        if (item.isSelected) {
                            ids.push(item.id);
                        }
                    })
                    if (ids.length == 0) {
                        layer.msg('请选择需要移除购物车的商品')
                        return;
                    }
                    layer.confirm('确认从购物车移除选中商品?', { title: '提示' }, function (index) {
                        layer.close(index);
                        httpRequest('POST', 'api_goods/carts/batch_delete', {
                            id: ids
                        },function (resp) {
                            layer.msg(resp.msg);
                            setTimeout(function () {
                                location.reload();
                            }, 500)
                        })
                    })
                },
                removeCarts: function (id) {
                    httpRequest('POST', 'api_goods/carts/batch_delete', {
                        id: id
                    },function (resp) {
                        layer.msg(resp.msg);
                        setTimeout(function () {
                            location.reload();
                        }, 500)
                    })
                },
                // 批量加入收藏夹
                addCollection: function () {
                    var ids = [];
                    this.carts.forEach(function (item) {
                        if (item.isSelected) {
                            ids.push(item.goods_info.id);
                        }
                    })
                    if (ids.length == 0) {
                        layer.msg('请选择需要加入收藏夹的商品')
                        return;
                    }
                    httpRequest('POST', 'api_goods/goods_collections/batch_save', {
                        goods_ids: ids
                    },function (resp) {
                        layer.msg(resp.msg)
                    })
                },
                addCollections: function (id) {
                    httpRequest('POST', 'api_goods/goods_collections/save', {
                        goods_id: id
                    },function (resp) {
                        layer.msg(resp.msg)
                    })
                },
                // 结算
                checkout: function () {
                    var goodsItem = this.carts.filter(function (item) {
                        return item.isSelected
                    });
                    var goodsList = [];
                    if (goodsItem.length == 0) {
                        layer.msg('未选中任何商品');
                    } else {
                        goodsItem.forEach(function (item) {
                            goodsList.push({
                                goods_info: item.goods_info,
                                select_spec_group_info: item.spec_group_info,
                                num: item.num
                            })
                        })
                        setStorage('goodsList', goodsList, sessionStorage);
                        goto('order_confirm');
                    }
                },
                gopage:function(data){
                    app.carts = [];
                    app.pages = []
                    this.activeclass = data
                    loadData(data)
                },
                selectSpecbox:function(cart){
                    goods_cate_id = cart.goods_info.goods_cate_id
                    httpRequest('post', 'api_query/goods_cates/template', { 'goods_cate_id': goods_cate_id},function (resp) {
                    app.spec_template = resp.data.spec_template;
                    console.log(resp);
                    cart.selectSpecs = !cart.selectSpecs
        //   初始化选中规格项
        //   var select_spec_group_info_option_ids = app.select_spec_group_info.spec_option_ids.split(',')
        //   app.spec_template.names.forEach(function (item) {
        //     app.goods.goods_spec_info[item.id].forEach(function (i) {
        //       if (select_spec_group_info_option_ids.indexOf(i.id.toString()) != -1) {
        //         Vue.set(i, 'isSelected', true);
        //       }
        //     })
            
        //   });
        })
                },
               
      },
      mounted: function () {
        httpRequest('POST', 'api_query/users/asset',{},function (resp) {
            app.level = resp.data.level;
            app.score = resp.data.score;
          })
            },
            computed: {
                // 计算总价格
                totalPrice: function () {
                    return this.carts.reduce(function (a, b) {
                        if (b.spec_group_id != 0) {
                            return a + (b.isSelected ? b.spec_group_info.sell_price * b.num : 0)
                        } else {
                            return a + (b.isSelected ? b.goods_info.sell_price * b.num : 0)
                        }
                    }, 0).toFixed(2)
                },
                totalnum: function () {
                    return this.carts.reduce(function (a, b) {
                        if (b.spec_group_id != 0) {
                            return a + (b.isSelected ? b.num : 0)
                        } else {
                            return a + (b.isSelected ? b.num : 0)
                        }
                    }, 0)
                },
                // 是否全选
                isSelectedAll: function () {
                    if (this.carts.length == 0) {
                        return false;
                    } else {
                        return this.carts.every(function (item) {
                            return item.isSelected
                        })
                    }
                },
            }
        })
        loadData = function (pages) {
            var page = pages || 1
            document.body.onscroll = null;
            httpRequest('POST', 'api_goods/carts/lists',{},function (resp) {
                if (resp.data.length > 0) {
                 app.haveNoData = false;
                    app.page = resp.page.data_count;
                    console.log(resp);
                    nampagee(app.page)
                   
                    resp.data.forEach(function (item) {
                        item.isSelected = false;
                        item.isEdit = false;
                        item.selectSpecs = true;
                        // 如果有规格项
                        if (item.spec_group_id != 0) {
                            // 商品规格组数组
                            item.goods_info.goods_spec_group_info.forEach(function (i) {
                                // 讲规格项组合ids进行自然序排序
                                i.spec_option_ids = i.spec_option_ids.split('_').sort().toString();
                                // 规格组名称转化为';'
                                i.spec_option_group = i.spec_option_group.replace(/_/g, ';');
                            })
                            // 购物车已经选择规格组名称和ids转化
                            item.spec_group_info.spec_option_ids = item.spec_group_info.spec_option_ids.split('_').sort().toString();
                            item.spec_group_info.spec_option_group = item.spec_group_info.spec_option_group.replace(/_/g, ';');
                        }
                        app.carts.push(item);        
                    })
                    if (resp.data.length == 5) {
                        
                    } else {
                        document.body.onscroll = null;
                    }
                } else {
                        app.haveNoData = true;
                }
            },{
                'page-num': page,
                'page-limit': 5
            })
        };
        loadData()
        function nampagee(){
            var page_li =  Math.ceil(app.page/5);
                   for (var index = 1; index <page_li + 1; index++) {
                      app.pages.push(index)
                };
        };
    </script>
</body>

</html>